# filepath: /home/rimuru/workspace/src/lmps/sme_compression_robust.lmp
# GOAL: Quasi-static Compression of NiTi Nanoparticle (Shape Memory Effect)
# METHOD: Harmonic Wall Anvils with correct force logging

clear
units       metal
dimension   3
boundary    s s s
atom_style  atomic

variable input_data string "minimized.data"
variable pot_lib string "library.meam"
variable pot_file string "NiTi.meam"
variable output_dir string "output"

read_data   ${input_data}

# --- POTENTIAL ---
pair_style  meam
pair_coeff  * * ${pot_lib} Ni Ti ${pot_file} Ni Ti

# Optimization: Smaller skin for statics/slow dynamics
neighbor    1.0 bin
neigh_modify delay 0 every 1 check yes

# ============================================
# 1. SETTINGS & VARIABLES
# ============================================
timestep    0.002

# Thermal Cycle
variable    T_low   equal 200.0
variable    T_high  equal 450.0
variable    tdamp   equal 100.0*dt

# Mechanical Loading (Quasi-static)
variable    strain_target  equal 0.12   # 12% (Aim high to see full transformation)
variable    load_time      equal 2000.0 # ps (2 ns) - Slower is better!
variable    load_steps     equal ${load_time}/dt

# --- COMPUTATIONS ---
compute pe_atom all pe/atom
compute stress  all stress/atom NULL

# [PHYSICS FIX] Use Centrosymmetry for Phase ID (B2 vs B19')
compute csym    all centro/atom 8
# CSP < 1.0 is roughly ordered (Austenite or twin boundaries)
# CSP > 2.0 indicates disorder or heavy shear
variable is_martensite atom "c_csym > 1.0" 

# 1. Zero Momentum (XY only)
fix freeze_mom all momentum 1000 linear 1 1 0 angular

# ============================================
# 2. PROTOCOL: PREPARATION
# ============================================
print "=== STEP 1: EQUILIBRATION (AUSTENITE) ==="
velocity all create ${T_high} 48274 dist gaussian
fix 1 all nvt temp ${T_high} ${T_high} ${tdamp}
run 10000

print "=== STEP 2: COOLING TO MARTENSITE ==="
fix 1 all nvt temp ${T_high} ${T_low} ${tdamp}
run 50000 # 100 ps cool
fix 1 all nvt temp ${T_low} ${T_low} ${tdamp}
run 10000

# ============================================
# 3. GEOMETRY MEASUREMENT (FIXED)
# ============================================
run 0
compute zmin_comp all reduce min z
compute zmax_comp all reduce max z
variable z_min_curr equal c_zmin_comp
variable z_max_curr equal c_zmax_comp
variable Lz_0 equal v_z_max_curr-v_z_min_curr

# Better area estimate (bounding box XY)
compute xmin_comp all reduce min x
compute xmax_comp all reduce max x
compute ymin_comp all reduce min y
compute ymax_comp all reduce max y
variable Lx equal c_xmax_comp-c_xmin_comp
variable Ly equal c_ymax_comp-c_ymin_comp
variable area_approx equal v_Lx*v_Ly

print "Initial Height (Lz_0): ${Lz_0} A"
print "Approx Area:           ${area_approx} A^2"

# ============================================
# 4. COMPRESSION SETUP
# ============================================

# Wall Physics
variable k_wall      equal 1000.0  # Stiff wall (eV/A^2)
variable total_disp  equal v_Lz_0*v_strain_target
variable half_disp   equal v_total_disp/2.0

# Dynamic Variables for Wall Positions
# We ramp from current position inwards
variable start_step  equal step
variable ramp        equal "(step - v_start_step) / v_load_steps"
# Clamp ramp to 0.0-1.0 to prevent crushing if we run extra steps
variable ramp_safe   equal "step > v_start_step + v_load_steps ? 1.0 : v_ramp"

variable pos_hi      equal "v_z_max_curr - (v_half_disp * v_ramp_safe)"
variable pos_lo      equal "v_z_min_curr + (v_half_disp * v_ramp_safe)"

# Define Walls (initially at boundaries)
fix top_wall all wall/harmonic zhi v_pos_hi ${k_wall} 0.0 2.5 units box
fix bot_wall all wall/harmonic zlo v_pos_lo ${k_wall} 0.0 2.5 units box

# OUTPUTS FOR STRESS-STRAIN CURVE (FIXED)
# Use virial stress instead of wall forces
compute pstress all pressure NULL virial
variable stress_zz equal c_pstress[3]  # Directly in bars
variable eng_stress equal "v_stress_zz * 1e-4"  # Convert bars to GPa

# Track martensite fraction
compute n_mart all reduce sum v_is_martensite
variable frac_mart equal c_n_mart/count(all)

fix data_out all print 200 &
    "$(step) $(temp) $(lz) $(v_true_strain) $(v_stress_zz) $(v_eng_stress) $(v_frac_mart)" &
    file ${output_dir}/stress_strain.txt screen no &
    title "# step temp Lz true_strain Stress_virial(bar) Stress(GPa) Martensite_Frac"

dump 1 all custom 2000 ${output_dir}/comp_*.dump id type x y z c_csym c_stress[3]
dump_modify 1 sort id

# ============================================
# 5. EXECUTE COMPRESSION
# ============================================
print "=== STEP 3: COMPRESSION START ==="
run ${load_steps}
print "=== COMPRESSION END ==="

# Hold compressed state briefly
run 5000

# ============================================
# 6. UNLOADING (Mechanical Recovery)
# ============================================
print "=== STEP 4: UNLOADING ==="
unfix top_wall
unfix bot_wall

# Allow elastic recovery
run 20000

variable Lz_unloaded equal lz
variable residual_strain equal "(v_Lz_0 - v_Lz_unloaded)/v_Lz_0"
print "Residual Strain: ${residual_strain}"

# ============================================
# 7. HEATING (SME Recovery)
# ============================================
print "=== STEP 5: HEATING (SHAPE MEMORY RECOVERY) ==="

fix 1 all nvt temp ${T_low} ${T_high} ${tdamp}
run 50000 # Heat up
fix 1 all nvt temp ${T_high} ${T_high} ${tdamp}
run 10000 # Equilibrate

variable Lz_final equal lz
variable recovery equal "(v_Lz_final - v_Lz_unloaded) / (v_Lz_0 - v_Lz_unloaded)"

print "Final Recovery Ratio: ${recovery}"
print "DONE."