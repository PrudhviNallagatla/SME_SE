# GOAL: Test superelasticity of 10nm NiTi nanoparticle
# Requires: Af < test_temp (verify from thermal cycling first!)

clear
units metal
dimension 3
boundary s s s
atom_style atomic

read_data ${input_data}

pair_style meam
pair_coeff * * ${pot_lib} Ni Ti ${pot_file} Ni Ti

neighbor 2.0 bin
neigh_modify delay 0 every 1 check yes

compute pe_atom all pe/atom
compute ke_atom all ke/atom
compute stress_atom all stress/atom NULL
compute centro all centro/atom bcc
compute cna all cna/atom 3.5
compute coord all coord/atom cutoff 3.5

timestep 0.001

# ============================================
# PARAMETERS (REALISTIC FOR 10nm NANOPARTICLE)
# ============================================

# ✅ Temperature: Must be > Af (use thermal cycling result!)
variable test_temp equal 400.0  # Safe choice (well above typical Af)

# ✅ Strain rate: Slow enough for transformation
variable strain_rate equal 5.0e-7  # 5×10^5 /s (literature standard)

# ✅ Max strain: Safe for nanoparticles
variable max_strain equal 0.05  # 5% (allows full transformation)

# Equilibration
variable equil_steps equal 200000  # 200 ps (nanoparticle needs longer)

# Loading/unloading steps
variable loading_time equal v_max_strain/v_strain_rate
variable strain_steps equal round(v_loading_time/dt)
# Time: 0.05 / 5e-7 = 100,000 ps = 100 ns = 100M steps (~9 hrs)

variable tdamp equal $(200.0*dt)

shell mkdir -p ${output_dir}

thermo 5000
thermo_style custom step temp pe press vol lx density pxx pyy pzz

dump 1 all custom 50000 ${output_dir}/se_*.dump &
    id type x y z c_pe_atom c_centro c_cna c_coord
dump_modify 1 sort id

# ============================================
# EQUILIBRATION
# ============================================
print "=========================================="
print "Equilibrating at ${test_temp}K (Austenite)"
print "=========================================="

velocity all create ${test_temp} ${seed} dist gaussian
fix 1 all nvt temp ${test_temp} ${test_temp} ${tdamp}
run ${equil_steps}
unfix 1

variable Lx_ref equal lx
variable pe_initial equal pe
variable coord_initial equal ave(c_coord)

print "Reference length: ${Lx_ref} A"
print "Initial PE/atom: $(pe/atoms) eV"
print "Initial coordination: ${coord_initial}"

write_restart ${output_dir}/se_initial.restart

# ============================================
# DEFINE DEFORMATION REGIONS (SPHERICAL)
# ============================================
variable xcm equal xcm(all,x)
variable ycm equal xcm(all,y)
variable zcm equal xcm(all,z)
variable radius equal (lx+ly+lz)/6.0

variable x_left equal v_xcm-0.75*v_radius
variable x_right equal v_xcm+0.75*v_radius

region left_grip sphere ${x_left} ${ycm} ${zcm} 5.0 units box
region right_grip sphere ${x_right} ${ycm} ${zcm} 5.0 units box

group anchor region left_grip
group pull region right_grip
group mobile subtract all anchor pull

print "Deformation setup: $(count(anchor)) anchor, $(count(pull)) pull"

# ============================================
# STRESS CALCULATION (CORRECT METHOD)
# ============================================
# Use virial stress tensor
compute stress_xx all reduce ave c_stress_atom[1]
variable stress_x equal "c_stress_xx * 160.2177"  # Convert to GPa

variable strain_x equal (lx-v_Lx_ref)/v_Lx_ref

fix stress_out all print 100 &
    "$(step) $(v_strain_x) $(v_stress_x) $(c_avg_coord)" &
    file ${output_dir}/stress_strain.txt screen no &
    title "# step strain stress(GPa) avg_coord"

# ============================================
# LOADING PHASE (TENSILE)
# ============================================
print "=========================================="
print "Loading: 0% → $(v_max_strain*100)% strain"
print "Rate: ${strain_rate} /s"
print "Steps: ${strain_steps} ($(v_loading_time/1000) ns)"
print "=========================================="

# ✅ Use fix deform (controlled strain rate, works with s s s)
fix 1 all nvt temp ${test_temp} ${test_temp} ${tdamp}
fix 2 all deform 1 x erate ${strain_rate} remap x units box

# Monitor transformation
compute avg_coord all reduce ave c_coord
fix transform_monitor all print 1000 &
    "$(step) $(v_strain_x) $(v_stress_x) $(c_avg_coord)" &
    file ${output_dir}/transformation_monitor.txt screen no

run ${strain_steps}

unfix transform_monitor
unfix 2
unfix 1

variable Lx_max equal lx
variable strain_max equal (v_Lx_max-v_Lx_ref)/v_Lx_ref

print "Maximum strain reached: $(v_strain_max*100)%"
write_restart ${output_dir}/se_loaded.restart

# ============================================
# HOLD AT MAX STRAIN
# ============================================
print "Equilibrating at maximum strain..."

fix 1 all nvt temp ${test_temp} ${test_temp} ${tdamp}
run ${equil_steps}
unfix 1

# ============================================
# UNLOADING (REMOVE CONSTRAINT, NATURAL RECOVERY)
# ============================================
print "=========================================="
print "Unloading: Removing constraint..."
print "=========================================="

# ✅ CORRECT: Just equilibrate (no reverse deformation!)
fix 1 all nvt temp ${test_temp} ${test_temp} ${tdamp}
run $(2*v_equil_steps)  # Longer equilibration for reverse transformation
unfix 1

variable Lx_final equal lx
variable strain_final equal (v_Lx_final-v_Lx_ref)/v_Lx_ref

write_restart ${output_dir}/se_unloaded.restart

# ============================================
# ANALYSIS
# ============================================
undump 1
unfix stress_out

variable recovered_strain equal v_strain_max - v_strain_final
variable recovery_eff equal v_recovered_strain / v_strain_max * 100

variable pe_final equal pe
variable coord_final equal ave(c_coord)
variable coord_change equal abs(v_coord_final - v_coord_initial)

print "=========================================="
print "SUPERELASTIC TEST RESULTS"
print "=========================================="
print "Reference length:    ${Lx_ref} A"
print "Maximum length:      ${Lx_max} A"
print "Final length:        ${Lx_final} A"
print "------------------------------------------"
print "Applied strain:      $(v_strain_max*100)%"
print "Final strain:        $(v_strain_final*100)%"
print "Recovered strain:    $(v_recovered_strain*100)%"
print "Recovery efficiency: ${recovery_eff}%"
print "=========================================="

# Validate superelasticity
if "${recovery_eff} > 90 && ${coord_change} < 0.5" then &
    "print '✓ SUPERELASTICITY CONFIRMED'" &
    "print '  - High recovery: ${recovery_eff}%'" &
    "print '  - Structure returned to austenite'" &
elif "${recovery_eff} > 90 && ${coord_change} >= 0.5" then &
    "print '⚠ High recovery BUT structure did not recover'" &
    "print '  Possible: Forced recovery (not true SE)'" &
else &
    "print '❌ NO SUPERELASTICITY'" &
    "print '  Recovery: ${recovery_eff}% (expected >90%)'"

print "=========================================="
print "Next steps:"
print "  1. Plot stress_strain.txt (look for plateau)"
print "  2. Check transformation_monitor.txt (coord changes)"
print "  3. Calculate hysteresis area (energy dissipation)"
print "=========================================="