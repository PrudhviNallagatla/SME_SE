# Superelastic mechanical testing for NiTi nanostructures
#
# SCIENTIFIC PRODUCTION SCRIPT
#
# Main Fixes:
# 1. Restored "production" simulation parameters (e.g., long runs).
# 2. Added a REAL stress calculation using 'compute reduce' (replaces 'stress_x = 0.0').
# 3. Fixed the 'fix move' command to use immediate-evaluation $(...) syntax.
# 4. Corrected all non-ASCII 'Å' symbols to 'A'.

clear
units metal
dimension 3
boundary s s s
atom_style atomic

read_data ${input_data}

# MEAM potential for NiTi
pair_style meam
pair_coeff * * ${pot_lib} Ni Ti ${pot_file} Ni Ti

neighbor 2.0 bin
neigh_modify delay 0 every 1 check yes

# Compute per-atom properties
compute pe_atom all pe/atom
compute ke_atom all ke/atom
compute stress_atom all stress/atom NULL
compute centro all centro/atom bcc
compute cna all cna/atom 3.5

timestep 0.001  # use this in real sim: 0.001 ps (1 fs)

# Test parameters (SCIENTIFIC values)
variable test_temp equal 300.0
variable strain_rate equal 1.0e-3   # use this in real sim: 1.0e-3 /ps (standard strain rate)
variable max_strain equal 0.08
variable equil_steps equal 50000   # use this in real sim: 50000 steps (100 ps)

# Corrected strain step calculation
variable loading_time equal v_max_strain/v_strain_rate
variable strain_steps equal round(v_loading_time/dt)

# Thermostat damping
variable tdamp equal $(100.0*dt)

shell mkdir -p ${output_dir}

thermo 1000
thermo_style custom step temp pe ke etotal press vol lx ly lz pxx pyy pzz

# Dump trajectory (FIXED: single line)
dump 1 all custom 1000 ${output_dir}/tensile_*.dump id type x y z c_pe_atom c_ke_atom c_centro c_cna c_stress_atom[1] c_stress_atom[2] c_stress_atom[3]
dump_modify 1 sort id

# ============================================
# Initial Equilibration
# ============================================
print "=========================================="
print "Equilibrating at ${test_temp} K..."
print "=========================================="

velocity all create ${test_temp} ${seed} dist gaussian
fix 1 all nvt temp ${test_temp} ${test_temp} ${tdamp}
run ${equil_steps}
unfix 1

write_restart ${output_dir}/equil_pre.restart

variable Lx_ref equal lx
variable Ly_ref equal ly
variable Lz_ref equal lz

print "Reference box: Lx=$(v_Lx_ref) Ly=$(v_Ly_ref) Lz=$(v_Lz_ref) A"

# ============================================
# Define Deformation Groups
# ============================================
# Define anchor/pull regions (1.0 A thick slices on each end)
variable x_left equal xlo+1.0
variable x_right equal xhi-1.0
region left_grip block INF ${x_left} INF INF INF INF units box
region right_grip block ${x_right} INF INF INF INF INF units box
group anchor region left_grip
group pull region right_grip
group mobile subtract all anchor pull
variable pull_vel equal v_strain_rate*v_Lx_ref
variable neg_pull_vel equal "-1.0 * v_pull_vel"

print "Deforming particle: $(count(anchor)) anchor atoms, $(count(pull)) pull atoms."

# ============================================
# --- CRITICAL: Define REAL Stress Calculation ---
# ============================================
# 1. Compute the total reaction force on the 'anchor' group
compute f_anchor anchor reduce sum fx
# 2. Calculate the initial cross-sectional area (Y-Z plane)
variable area_yz equal "v_Ly_ref * v_Lz_ref"
# 3. Calculate stress (Force/Area) and convert to GPa
#    (1 eV/A^3 = 160.2177 GPa)
variable stress_x_calc equal "(c_f_anchor / v_area_yz) * 160.2177"


# ============================================
# Define strain and stress variables for output
# ============================================
variable strain_x equal (lx-v_Lx_ref)/v_Lx_ref
variable strain_y equal (ly-v_Ly_ref)/v_Ly_ref
variable strain_z equal (lz-v_Lz_ref)/v_Lz_ref

# --- FIXED: Use the REAL stress calculation ---
variable stress_x equal v_stress_x_calc
variable stress_y equal 0.0 # Y-stress is not tracked in this uniaxial test
variable stress_z equal 0.0 # Z-stress is not tracked in this uniaxial test

# FIXED: single line
fix stress_out all print 50 "$(step) $(temp) $(pe) $(v_strain_x) $(v_strain_y) $(v_strain_z) $(v_stress_x) $(v_stress_y) $(v_stress_z)" file ${output_dir}/stress_strain.txt screen no title "# step temp pe strain_x strain_y strain_z stress_x(GPa) stress_y(GPa) stress_z(GPa)"

# ============================================
# Loading Phase (Tensile deformation)
# ============================================
print "=========================================="
print "Loading phase: tensile strain along x-axis"
print "Strain rate: ${strain_rate} /ps for ${loading_time} ps"
print "Total steps: ${strain_steps}"
print "=========================================="

fix 1 mobile nvt temp ${test_temp} ${test_temp} ${tdamp}
fix 2 anchor setforce 0.0 0.0 0.0
# --- FIXED: Use $(...) to evaluate variable immediately ---
fix 3 pull move linear $(v_pull_vel) 0.0 0.0

run ${strain_steps}

unfix 3
unfix 2
unfix 1

variable Lx_max equal lx
variable strain_applied equal (v_Lx_max-v_Lx_ref)/v_Lx_ref

print "Max strain reached: $(v_strain_applied*100)%"
write_restart ${output_dir}/max_strain.restart

# ============================================
# Hold at Maximum Strain
# ============================================
print "Equilibrating at maximum strain..."

fix 1 mobile nvt temp ${test_temp} ${test_temp} ${tdamp}
fix 2 anchor setforce 0.0 0.0 0.0
fix 3 pull setforce 0.0 0.0 0.0  # Hold pull group in place

run ${equil_steps}

unfix 3
unfix 2
unfix 1

# ============================================
# Unloading Phase (Reverse deformation)
# ============================================
print "=========================================="
print "Unloading phase: releasing tensile strain"
print "=========================================="

fix 1 mobile nvt temp ${test_temp} ${test_temp} ${tdamp}
fix 2 anchor setforce 0.0 0.0 0.0
# --- FIXED: Use $(...) to evaluate variable immediately ---
fix 3 pull move linear ${neg_pull_vel} 0.0 0.0 # Reverse velocity

run ${strain_steps}

unfix 3
unfix 2
unfix 1

# ============================================
# Final Equilibration
# ============================================
print "Final equilibration after unloading..."

# Thermostat all atoms to let the whole particle relax
fix 1 all nvt temp ${test_temp} ${test_temp} ${tdamp}
run ${equil_steps}
unfix 1

# ============================================
# Calculate Recovery Metrics
# ============================================
variable Lx_final equal lx
variable residual_strain equal (v_Lx_final-v_Lx_ref)/v_Lx_ref
# FIXED: Use "equal" with quotes for formula
variable strain_applied_safe equal "v_strain_applied + 1e-9"
variable recovery_pct equal "(v_strain_applied-v_residual_strain)/v_strain_applied_safe*100"

write_data ${output_dir}/final.data
write_restart ${output_dir}/final.restart

undump 1
unfix stress_out

# ============================================
# Summary
# ============================================
print "=========================================="
print "SUPERELASTIC TEST COMPLETE"
print "=========================================="
print "Applied strain:   $(v_strain_applied) ($(v_strain_applied*100)%)"
print "Residual strain:  $(v_residual_strain) ($(v_residual_strain*100)%)"
print "Shape recovery:   $(v_recovery_pct)%"
print "=========================================="
print "Reference length: $(v_Lx_ref) A"
print "Max length:       $(v_Lx_max) A"
print "Final length:     $(v_Lx_final) A"
print "=========================================="