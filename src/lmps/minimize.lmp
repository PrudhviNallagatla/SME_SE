# Energy minimization for NiTi nanostructures
#
# NOTE: All file paths (structure_file, output_dir, pot_lib, pot_file)
# are passed from the mpirun command via the -var flag.

clear
units metal
dimension 3
boundary s s s
atom_style atomic

read_data ${structure_file}

# MEAM potential for NiTi
pair_style meam
# FIXED: Use variables for portable potential paths
pair_coeff * * ${pot_lib} Ni Ti ${pot_file} Ni Ti

neighbor 2.0 bin
neigh_modify delay 5 every 1

# Compute per-atom properties
compute pe all pe/atom
compute ke all ke/atom
compute stress all stress/atom NULL

thermo 100
thermo_style custom step temp pe ke etotal press vol lx ly lz

shell mkdir -p ${output_dir}

# Dump initial structure
dump 1 all custom 1 ${output_dir}/initial.dump id type x y z c_pe c_ke c_stress[1] c_stress[2] c_stress[3]
dump_modify 1 sort id
run 0
undump 1

# Tighter convergence
minimize 1.0e-8 1.0e-10 10000 50000

# Save minimized structure
write_data ${output_dir}/minimized.data
write_restart ${output_dir}/minimized.restart

# Dump final structure
dump 2 all custom 1 ${output_dir}/minimized.dump id type x y z c_pe c_ke c_stress[1] c_stress[2] c_stress[3]
dump_modify 2 sort id
run 0
undump 2

# Print final state
variable final_pe equal pe
variable final_press equal press
variable final_lx equal lx
variable final_ly equal ly
variable final_lz equal lz

print "=========================================="
print "MINIMIZATION COMPLETE"
print "=========================================="
print "Final PE:       ${final_pe} eV"
print "Final Pressure: ${final_press} bar"
print "Box size:       ${final_lx} x ${final_ly} x ${final_lz} Ã…"
print "=========================================="