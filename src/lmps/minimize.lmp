# filepath: /home/rimuru/workspace/src/lmps/niti_minimize_robust_v2.lmp
# GOAL: Robust Energy Minimization for NiTi Nanoparticles (REFINED)
# MODIFICATIONS: Adjusted neighbor skin, removed MEAM shift, fixed density logic

clear
units       metal
dimension   3
boundary    s s s   
atom_style  atomic

# --- SETUP ---
read_data   ${structure_file}

# [ADJUSTMENT] MEAM usually handles cutoffs internally. 'shift yes' removed to preserve physics.
pair_style  meam
pair_coeff  * * ${pot_lib} Ni Ti ${pot_file} Ni Ti

# [OPTIMIZATION] Reduced skin distance for faster minimization
neighbor    0.3 bin 
neigh_modify delay 0 every 1 check yes

# Hardware balancing
balance     1.0 shift xyz 20 1.1

# --- COMPUTES ---
compute pe_atom all pe/atom
compute stress  all stress/atom NULL
compute csym    all centro/atom bcc
compute coord   all coord/atom cutoff 3.5

# Reductions
compute avg_co_c all reduce ave c_coord
compute max_co_c all reduce max c_coord

# --- OUTPUT SETUP ---
thermo      100
# Replaced 'press' (meaningless for free NP) with 'pe' and 'fmax'
thermo_style custom step temp pe epair fmax fnorm c_avg_co_c

shell       mkdir -p ${output_dir}

# --- INITIAL STATE CHECK ---
run 0 post no # 'post no' skips the full neighbor build if possible, just inits variables

variable natoms equal count(all)
variable pe_per_atom equal pe/v_natoms

print "=========================================="
print "INITIAL STRUCTURE DIAGNOSTIC"
print "Atoms:            ${natoms}"
print "Initial PE/atom:  ${pe_per_atom} eV"
print "=========================================="

# Safety Check: Overlaps
if "${pe_per_atom} > 5.0" then &
    "print 'CRITICAL ERROR: Severe atomic overlaps detected (PE > 5 eV/atom).'" &
    "print 'Check input structure geometry.'" &
    "quit 1"

# ============================================
# STAGE 1: SOFTENING (Steepest Descent)
# ============================================
print ">>> STAGE 1: Steepest Descent (Untangling overlaps)..."
min_style sd
min_modify dmax 0.1 
minimize 1.0e-4 1.0e-6 5000 10000

# ============================================
# STAGE 2: CONVERGENCE (Conjugate Gradient)
# ============================================
print ">>> STAGE 2: Conjugate Gradient (Efficient minimization)..."
min_style cg
minimize 1.0e-6 1.0e-8 10000 20000

# ============================================
# STAGE 3: POLISHING (FIRE)
# ============================================
print ">>> STAGE 3: Final Polish (FIRE)..."
min_style fire 
minimize 1.0e-10 1.0e-10 20000 50000

# ============================================
# FINAL VALIDATION
# ============================================
# Force evaluation of variables
run 0

variable final_fmax equal fmax
variable final_pe equal pe
variable final_pe_atom equal v_final_pe/v_natoms

# [LOGIC FIX] Calculating approximate density based on convex hull is hard in script.
# Instead, we check PE/atom, which is the most reliable indicator of phase stability.

# 1. Convergence Check
if "${final_fmax} > 0.01" then &
    "print 'WARNING: Forces not fully converged (fmax = ${final_fmax})'" &
    "write_data ${output_dir}/unconverged.data"

# 2. Energy Check (NiTi B2 ~ -4.9 eV/atom)
# Surface atoms have higher energy (less negative). 
# If PE is > -3.8 (e.g., -3.0), the core is likely not crystalline or surfaces are bad.
if "${final_pe_atom} > -3.8" then &
    "print 'ERROR: Energy suspiciously high (${final_pe_atom} eV). Structure likely unstable.'" &
    "quit 1"

# --- FINAL OUTPUT ---
write_data ${output_dir}/minimized.data
write_restart ${output_dir}/minimized.restart

dump 1 all custom 1 ${output_dir}/minimized.dump id type x y z c_pe_atom c_csym c_coord
dump_modify 1 sort id
run 0

print "=========================================="
print "SUCCESS: MINIMIZATION COMPLETE"
print "=========================================="
print "Final PE/atom: ${final_pe_atom} eV"
print "Final fmax:    ${final_fmax} eV/A"
print "Note: Density check skipped (invalid for 's' boundaries)"
print "=========================================="