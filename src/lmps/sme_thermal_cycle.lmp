# filepath: /home/rimuru/workspace/src/lmps/sme_thermal_cycle_refined.lmp
# ==========================================================================
# GOAL: Robust NiTi Nanoparticle Hysteresis (Refined)
# IMPROVEMENTS: Static Core Definition, Centrosymmetry Analysis, Safe Thermostat
# ==========================================================================

clear
units       metal
dimension   3
boundary    s s s   
atom_style  atomic

# --- INPUT ---
read_data   ${input_data}

# --- POTENTIAL ---
pair_style  meam
pair_coeff  * * ${pot_lib} Ni Ti ${pot_file} Ni Ti

# --- OPTIMIZATION ---
# Reduced skin to 1.0 for better performance in long runs
neighbor    1.0 bin
neigh_modify delay 0 every 1 check yes

# ============================================
# 1. SETUP & VARIABLES
# ============================================
timestep    0.002

# Cycle Parameters
variable    T_low   equal 200.0   # M_f region
variable    T_high  equal 450.0   # A_f region
variable    T_rate  equal 0.05    # K/ps (50 K/ns)
variable    tdamp   equal 100.0*dt

# Duration Calculations
variable    delta_T     equal (v_T_high-v_T_low)
variable    run_ramp    equal round(v_delta_T/v_T_rate/dt)
variable    run_hold    equal 50000

# ============================================
# 2. PHYSICS & GROUPS (FIXED)
# ============================================

fix freeze_mom all momentum 1000 linear 1 1 1 angular

# CORRECT Way: Define core based on initial distance from COM
variable xcm equal xcm(all,x)
variable ycm equal xcm(all,y)
variable zcm equal xcm(all,z)

# Calculate distance for each atom (do this ONCE)
variable rsq atom (x-${xcm})^2+(y-${ycm})^2+(z-${zcm})^2
variable rmax equal sqrt(bound(all,zmax)^2+bound(all,ymax)^2+bound(all,xmax)^2)
variable rcut equal 0.8*v_rmax

# Create STATIC group using initial positions
group core variable rsq < v_rcut*v_rcut
group surface subtract all core

# ============================================
# 3. ADVANCED COMPUTES (FIXED)
# ============================================

compute pe_all all pe/atom
compute T_core core temp
compute csym all centro/atom bcc 8 8

# Correct way: use group-based filtering
compute csym_core core reduce ave c_csym
variable is_aus_core atom "c_csym < 0.5"
compute n_aus core reduce sum v_is_aus_core
variable n_core equal count(core)
variable frac_aus equal c_n_aus/v_n_core

# ============================================
# 4. OUTPUT STREAMS
# ============================================

thermo      1000
# Monitor T_core specifically to ensure the thermostat works inside the particle
thermo_style custom step temp c_T_core pe v_frac_aus vol

# Hysteresis Data File
# We print frequently (every 500 steps) to capture the phase transition sharpness
fix data_out all print 500 &
    "$(step) $(temp) $(c_T_core) $(pe) $(vol) $(v_frac_aus)" &
    file ${output_dir}/hysteresis.txt screen no &
    title "# step T_global T_core PE Vol Austenite_Frac"

# Visualization (Color by CSP to see domains)
dump 1 all custom 5000 ${output_dir}/dump.cycle.* id type x y z c_csym c_pe_all
dump_modify 1 sort id element Ni Ti

# ============================================
# 5. THERMAL PROTOCOL
# ============================================

print "=========================================="
print " SYSTEM DIAGNOSTICS "
print " Core Atoms: ${n_core_atoms}"
print "=========================================="

# --- INITIALIZATION ---
velocity all create ${T_high} 492845 dist gaussian
reset_timestep 0

# --- EQUILIBRATION (High T) ---
print ">>> STAGE 0: Equilibrating Austenite (${T_high} K)..."
fix 1 all nvt temp ${T_high} ${T_high} ${tdamp}
run ${run_hold}

# --- CYCLE 1: COOLING (A -> M) ---
print ">>> STAGE 1: Cooling (${T_high} -> ${T_low} K)..."
# Note: We overwrite fix 1. This is cleaner than unfix/fix.
fix 1 all nvt temp ${T_high} ${T_low} ${tdamp}
run ${run_ramp}

print ">>> STAGE 2: Holding Martensite (${T_low} K)..."
fix 1 all nvt temp ${T_low} ${T_low} ${tdamp}
run ${run_hold}

# --- CYCLE 1: HEATING (M -> A) ---
print ">>> STAGE 3: Heating (${T_low} -> ${T_high} K)..."
fix 1 all nvt temp ${T_low} ${T_high} ${tdamp}
run ${run_ramp}

print ">>> STAGE 4: Holding Austenite (${T_high} K)..."
fix 1 all nvt temp ${T_high} ${T_high} ${tdamp}
run ${run_hold}

# --- FINAL CHECK ---
write_data ${output_dir}/final_structure.data
print "SIMULATION COMPLETE."