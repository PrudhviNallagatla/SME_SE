# filepath: /home/rimuru/workspace/src/lmps/sme_thermal_cycle.lmp
# GOAL: Find transformation temperatures for NiTi NANOPARTICLE
# Based on: Ko et al. 2015, Zhong et al. 2014 (nanoparticle MD methods)

clear
units metal
dimension 3

# ✅ CORRECT: Shrink-wrap for nanoparticles (not fixed!)
boundary s s s  
atom_style atomic

read_data ${input_data}

# MEAM potential
pair_style meam
pair_coeff * * ${pot_lib} Ni Ti ${pot_file} Ni Ti

# ✅ Optimized for nanoparticles
neighbor 2.0 bin
neigh_modify delay 0 every 1 check yes

processors * * * grid numa
balance 1.0 shift xyz 20 1.1

# ============================================
# Computes for Structure Analysis
# ============================================
compute pe_atom all pe/atom
compute ke_atom all ke/atom
compute stress_atom all stress/atom NULL

# ✅ BCC centro-symmetry
compute centro all centro/atom bcc

# ✅ CNA for phase identification
compute cna all cna/atom 3.5

# ✅ NEW: Coordination to detect transformation
compute coord all coord/atom cutoff 3.5
compute avg_coord all reduce ave c_coord

# ✅ NEW: Radial distribution to track structure
compute rdf all rdf 100 1 2  # Ni-Ti pairs
fix rdf_output all ave/time 1000 1 1000 c_rdf[*] file ${output_dir}/rdf.dat mode vector

# ✅ NEW: Potential energy derivative (transformation indicator)
variable pe_per_atom equal pe/atoms

# ============================================
# Simulation Parameters
# ============================================
timestep 0.001  # 1 fs

variable T_low equal 50.0
variable T_high equal 400.0

# ✅ NANOPARTICLE-SPECIFIC RATE (literature-validated)
# Testing: 5 K/ps (7,000 steps) - 30 min runtime
# Production: 0.5 K/ps (70,000 steps) - 6 hr runtime
# Experimental: 0.05 K/ps (700,000 steps) - 60 hr runtime
variable T_rate equal 0.5  # Start with 5 K/ps for testing

variable temp_diff equal (v_T_high-v_T_low)
variable steps_ramp equal round(v_temp_diff/v_T_rate)

# ✅ Size-dependent equilibration
# Rule: 100 ps minimum for nanoparticles (vs 20 ps for bulk)
variable equil_steps equal 100000  # 100 ps

# ✅ Gentler damping for nanoparticles (surface atoms need longer coupling)
variable tdamp equal $(200.0*dt)  # 200 fs (not 100 fs)

shell mkdir -p ${output_dir}

# ✅ Add structure metrics to thermo
thermo 1000
thermo_style custom step temp pe ke etotal press vol density &
                    c_avg_coord lx ly lz pxx pyy pzz

# ✅ Remove duplicate stress columns
dump 1 all custom 5000 ${output_dir}/thermal_*.dump &
    id type x y z &
    c_pe_atom c_ke_atom &
    c_centro c_cna c_coord &
    c_stress_atom[1] c_stress_atom[2] c_stress_atom[3] &
    c_stress_atom[4] c_stress_atom[5] c_stress_atom[6]
dump_modify 1 sort id

# ✅ Reduce I/O (1000 instead of 100)
fix thermo_out all print 1000 &
    "$(step) $(temp) $(v_pe_per_atom) $(vol) $(c_avg_coord)" &
    file ${output_dir}/thermo_detailed.txt screen no &
    title "# step temp pe_per_atom vol avg_coord"

# ✅ Auto-restart every 50k steps
restart 50000 ${output_dir}/restart.*.bin

# ============================================
# Print simulation info
# ============================================
print "=========================================="
print "NANOPARTICLE THERMAL CYCLING SIMULATION"
print "=========================================="
print "Temperature range: ${T_low} - ${T_high} K"
print "Cooling/heating rate: ${T_rate} K/ps"
print "Steps per ramp: ${steps_ramp}"
print "Equilibration steps: ${equil_steps} (100 ps)"
print "Total ramps: 4 (2 cycles × 2 directions)"
print "Total steps: $(4*v_steps_ramp + 4*v_equil_steps)"
print "Estimated runtime: ~$(4*v_steps_ramp/1000/60) min"
print "=========================================="

# ============================================
# Initial Equilibration at T_high
# ============================================
print "=== Equilibrating at ${T_high} K (Austenite) ==="
velocity all create ${T_high} ${seed} dist gaussian

# ✅ NVT ONLY (no NPT for nanoparticles with shrink-wrap!)
fix 1 all nvt temp ${T_high} ${T_high} ${tdamp}

run ${equil_steps}
unfix 1

# ✅ Record initial state
variable initial_pe equal pe/atoms
variable initial_vol equal vol
variable initial_lx equal lx
variable initial_coord equal c_avg_coord

print "Initial Austenite state:"
print "  PE/atom: ${initial_pe} eV"
print "  Volume: ${initial_vol} Å³"
print "  Box size: ${initial_lx} Å (average)"
print "  Avg coordination: ${initial_coord}"

write_restart ${output_dir}/initial_high.restart

# ============================================
# CYCLE 1: Cooling (A → M)
# ============================================
print "=========================================="
print "CYCLE 1: COOLING ${T_high} → ${T_low} K"
print "=========================================="

fix 1 all nvt temp ${T_high} ${T_low} ${tdamp}
run ${steps_ramp}
unfix 1

print "=== Equilibrating at ${T_low} K (Martensite) ==="
fix 1 all nvt temp ${T_low} ${T_low} ${tdamp}
run ${equil_steps}
unfix 1

# ✅ Check transformation
variable martens_pe equal pe/atoms
variable martens_vol equal vol
variable martens_lx equal lx
variable martens_coord equal c_avg_coord
variable delta_pe equal v_martens_pe-v_initial_pe
variable delta_vol_pct equal 100*(v_martens_vol/v_initial_vol - 1)

print "Martensite state:"
print "  PE/atom: ${martens_pe} eV (ΔPE = ${delta_pe} eV)"
print "  Volume: ${martens_vol} Å³ (ΔV = ${delta_vol_pct}%)"
print "  Box size: ${martens_lx} Å"
print "  Avg coordination: ${martens_coord}"

# ✅ Check if transformation occurred
if "${delta_pe} < -0.05" then &
    "print '✓ Transformation detected (PE dropped by ${delta_pe} eV)'" &
else &
    "print '⚠ No clear transformation (ΔPE = ${delta_pe} eV)'" &
    "print '  Consider slower cooling rate or longer equilibration'"

write_restart ${output_dir}/cycle1_low.restart

# ============================================
# CYCLE 1: Heating (M → A)
# ============================================
print "=========================================="
print "CYCLE 1: HEATING ${T_low} → ${T_high} K"
print "=========================================="

fix 1 all nvt temp ${T_low} ${T_high} ${tdamp}
run ${steps_ramp}
unfix 1

print "=== Equilibrating at ${T_high} K (Austenite) ==="
fix 1 all nvt temp ${T_high} ${T_high} ${tdamp}
run ${equil_steps}
unfix 1

write_restart ${output_dir}/cycle1_high.restart

# ============================================
# CYCLE 2: Repeat for hysteresis verification
# ============================================
print "=========================================="
print "CYCLE 2: COOLING ${T_high} → ${T_low} K"
print "=========================================="

fix 1 all nvt temp ${T_high} ${T_low} ${tdamp}
run ${steps_ramp}
unfix 1

print "=== Equilibrating at ${T_low} K ==="
fix 1 all nvt temp ${T_low} ${T_low} ${tdamp}
run ${equil_steps}
unfix 1

write_restart ${output_dir}/cycle2_low.restart

print "=========================================="
print "CYCLE 2: HEATING ${T_low} → ${T_high} K"
print "=========================================="

fix 1 all nvt temp ${T_low} ${T_high} ${tdamp}
run ${steps_ramp}
unfix 1

print "=== Equilibrating at ${T_high} K ==="
fix 1 all nvt temp ${T_high} ${T_high} ${tdamp}
run ${equil_steps}
unfix 1

write_restart ${output_dir}/cycle2_high.restart

# ============================================
# Final state
# ============================================
write_data ${output_dir}/final.data

undump 1
unfix thermo_out
unfix rdf_output

variable final_pe equal pe/atoms
variable final_vol equal vol

print "=========================================="
print "THERMAL CYCLING COMPLETE"
print "=========================================="
print "Final state at ${T_high} K:"
print "  PE/atom: ${final_pe} eV"
print "  Volume: ${final_vol} Å³"
print "=========================================="
print "Output files:"
print "  - thermo_detailed.txt (PE, coord vs T)"
print "  - rdf.dat (radial distribution evolution)"
print "  - thermal_*.dump (atomic snapshots)"
print "  - restart.*.bin (checkpoints)"
print "=========================================="
print "Analysis workflow:"
print "  1. Plot PE/atom vs Temperature"
print "  2. Find slope changes (dPE/dT) → transformation temps"
print "  3. Check volume hysteresis"
print "  4. Visualize dump files (OVITO/VMD)"
print "=========================================="